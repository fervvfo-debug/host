name: Win-11-128Cores-32GB-512SSD-RDP-Ngrok

on:
  workflow_dispatch:

jobs:
  win-rdp:
    runs-on: [self-hosted, windows]

    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}

    steps:
    - name: Print system info
      shell: pwsh
      run: |
        Write-Host "=== SYSTEM INFO ==="
        $cs = Get-CimInstance Win32_ComputerSystem
        $ram = [math]::Round($cs.TotalPhysicalMemory / 1GB, 2)
        Write-Host "RAM: $ram GB"

        $cores = (Get-CimInstance Win32_Processor |
          Measure-Object -Property NumberOfLogicalProcessors -Sum).Sum
        Write-Host "Cores: $cores"

        $disk = Get-PSDrive C:
        $diskGB = [math]::Round(($disk.Used + $disk.Free) / 1GB, 2)
        Write-Host "Disk: $diskGB GB"

    - name: Install ngrok
      shell: pwsh
      run: |
        $dir = "$env:USERPROFILE\ngrok"
        $exe = "$dir\ngrok.exe"

        if (!(Test-Path $exe)) {
          New-Item -ItemType Directory -Path $dir -Force | Out-Null
          $zip = "$dir\ngrok.zip"

          Invoke-WebRequest `
            "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" `
            -OutFile $zip

          Expand-Archive $zip -DestinationPath $dir -Force
          Remove-Item $zip -Force
        }

        Write-Host "ngrok ready."

    - name: Configure ngrok
      shell: pwsh
      run: |
        $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
        if (!$env:NGROK_AUTHTOKEN) {
          throw "NGROK_AUTHTOKEN missing"
        }
        & $ngrok authtoken $env:NGROK_AUTHTOKEN

    - name: Enable RDP + anti-offline
      shell: pwsh
      run: |
        Write-Host "Configuring RDP..."

        Set-ItemProperty `
          "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
          fDenyTSConnections 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop" `
          -ErrorAction SilentlyContinue

        sc.exe config TermService start= auto | Out-Null
        Set-Service TermService -StartupType Automatic
        Start-Service TermService -ErrorAction SilentlyContinue

        sc.exe failure TermService `
          reset= 0 `
          actions= restart/60000/restart/60000/restart/60000 | Out-Null

        $monitor = Join-Path $env:ProgramData "Keep-TermService-Alive.ps1"

        @'
$svc = Get-Service TermService -ErrorAction SilentlyContinue | Select-Object -First 1

if ($null -eq $svc) {
    Write-Host "TermService not found"
    exit 0
}

if ($svc.Status -ne "Running") {
    Start-Service TermService -ErrorAction SilentlyContinue
}
Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
'@ | Set-Content $monitor -Encoding UTF8 -Force

        schtasks /Delete /TN "Keep-TermService-Alive" /F 2>$null
        schtasks /Create `
          /SC MINUTE /MO 5 `
          /TN "Keep-TermService-Alive" `
          /RU SYSTEM `
          /TR "powershell -NoProfile -WindowStyle Hidden -ExecutionPolicy Bypass -File `"$monitor`"" `
          /F | Out-Null

        Write-Host "RDP protection active."

    - name: Create RDP user
      shell: pwsh
      run: |
        $user = "rdpuser"
        $pw = $env:RDP_PASSWORD
        if (!$pw) { $pw = "Rdp12345!" }

        $sec = ConvertTo-SecureString $pw -AsPlainText -Force

        if (!(Get-LocalUser $user -ErrorAction SilentlyContinue)) {
          New-LocalUser $user -Password $sec
        } else {
          Set-LocalUser $user -Password $sec
        }

        Add-LocalGroupMember administrators $user -ErrorAction SilentlyContinue
        Write-Host "RDP user ready."

    - name: Start ngrok tunnel
      shell: pwsh
      run: |
        $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
        Start-Process $ngrok -ArgumentList "tcp 3389" -WindowStyle Hidden

        Start-Sleep 15

        $tunnels = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
        $tcp = $tunnels.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1

        if ($tcp) {
          Write-Host "==============================="
          Write-Host "RDP ADDRESS: $($tcp.public_url)"
          Write-Host "USER: rdpuser"
          Write-Host "PASS: (secret)"
          Write-Host "==============================="
        } else {
          Write-Warning "No TCP tunnel yet"
        }

    - name: Keep alive
      shell: pwsh
      run: |
        while ($true) {
          Write-Host "HEARTBEAT $(Get-Date -Format o)"
          Start-Sleep 300
        }

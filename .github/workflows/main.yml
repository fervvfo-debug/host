name: Win11-RDP-Test

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted

    env:
      NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
      RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}

    steps:
      - name: System info
        shell: powershell
        run: |
          Write-Host "Runner OK"
          hostname
          whoami
          $PSVersionTable

      - name: Install ngrok
        shell: powershell
        run: |
          $dir = "$env:USERPROFILE\ngrok"
          $exe = "$dir\ngrok.exe"

          if (!(Test-Path $exe)) {
            New-Item -ItemType Directory -Path $dir -Force | Out-Null
            $zip = "$dir\ngrok.zip"

            Invoke-WebRequest `
              "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip" `
              -OutFile $zip

            Expand-Archive $zip -DestinationPath $dir -Force
            Remove-Item $zip -Force
          }

          & $exe version

      - name: Configure ngrok
        shell: powershell
        run: |
          if (!$env:NGROK_AUTHTOKEN) {
            throw "NGROK_AUTHTOKEN missing"
          }
          & "$env:USERPROFILE\ngrok\ngrok.exe" authtoken $env:NGROK_AUTHTOKEN

      - name: Enable RDP + anti-offline
        shell: powershell
        run: |
          Set-ItemProperty `
            "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
            -Name fDenyTSConnections -Value 0

          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" `
            -ErrorAction SilentlyContinue

          sc.exe config TermService start= auto | Out-Null
          Set-Service TermService -StartupType Automatic
          Start-Service TermService -ErrorAction SilentlyContinue

          sc.exe failure TermService `
            reset= 0 `
            actions= restart/60000/restart/60000/restart/60000 | Out-Null

      - name: Create RDP user
        shell: powershell
        run: |
          $user = "rdpuser"
          $pw = $env:RDP_PASSWORD
          if (!$pw) { $pw = "Rdp12345!" }

          $sec = ConvertTo-SecureString $pw -AsPlainText -Force

          if (!(Get-LocalUser $user -ErrorAction SilentlyContinue)) {
            New-LocalUser $user -Password $sec
          } else {
            Set-LocalUser $user -Password $sec
          }

          Add-LocalGroupMember administrators $user -ErrorAction SilentlyContinue

      - name: Start ngrok tunnel
        shell: powershell
        run: |
          $ngrok = "$env:USERPROFILE\ngrok\ngrok.exe"
          Start-Process $ngrok -ArgumentList "tcp 3389" -WindowStyle Hidden

          Start-Sleep 15

          $api = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
          $tcp = $api.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1

          if ($tcp) {
            Write-Host "==============================="
            Write-Host "RDP ADDRESS: $($tcp.public_url)"
            Write-Host "USER: rdpuser"
            Write-Host "PASS: (secret)"
            Write-Host "==============================="
          } else {
            Write-Warning "No TCP tunnel yet"
          }

      - name: Keep alive
        shell: powershell
        run: |
          while ($true) {
            Write-Host "HEARTBEAT $(Get-Date -Format o)"
            Start-Sleep 300
          }
